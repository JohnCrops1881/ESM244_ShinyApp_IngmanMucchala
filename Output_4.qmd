---
title: "Output_4"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(tsibble)
library(feasts)
library(fable)
library(here)
library(janitor)
library(sf)
library(tmap)
library(dplyr)
library(here)
```

Pseudocode
X  Input and simplify LEAD, county, sunroof
X  join lead df and sunroof df county info to county sf polygons (how to do this w df/sf?)
-  test map 
-  MCA of high solar potential or high sunlight threshold, high energy burden (3 or 4%?), low median household income, high #households(s?), high count qualified (?)
- map with widget

if want to specifcy thresholds:
- yearly sunlight total kwh (total solar energy generation potential for all roof space): >10^8 kwh? bias against smaller counties
- energy burden: 3 or 4%
- household income: <$91,905 (2022 CA median household income)
- # households and count qualified (# buildings solar suitable): -> # suitable buildings divided by #households (rough similarity) *100 = %suitable buildings -> >50%? prioritize counties with high solar potential?

```{r}
lead_df_raw <- read_csv(here("data", "LEAD_CA_County.csv")) %>% 
  janitor::clean_names()

lead_df <- lead_df_raw %>% 
  select(c(county, energy_burden_percent_income, avg_annual_energy_cost, total_households, household_income))

sunroof_df_raw <- read_csv(here("data", "project_sunroof_county_2019.csv")) %>% 
  janitor::clean_names() 

sunroof_df <- sunroof_df_raw %>% 
  select(c(region_name, lat_avg, lng_avg, yearly_sunlight_kwh_kw_threshold_avg, count_qualified, percent_covered, percent_qualified, number_of_panels_median, number_of_panels_total, yearly_sunlight_kwh_median, yearly_sunlight_kwh_total, existing_installs_count))

county_sf <- read_sf(here("data", "ca_counties", "CA_Counties_TIGER2016.shp")) %>% 
  janitor::clean_names() %>% 
  select(c(name, geometry))
```

```{r}
# join the 3 datasets to county polygons
county_sunroof_sf <- full_join(county_sf, sunroof_df, by=c("name"="region_name")) %>% 
  drop_na()

county_sunroof_lead_sf <- full_join(county_sunroof_sf, lead_df, by=c("name"="county")) %>% 
  drop_na()
```

```{r}
ggplot() + 
  geom_sf(data = county_sf) +
  geom_sf(data = county_sunroof_lead_sf, aes(fill = energy_burden_percent_income), size = 2) + # size = border
  scale_fill_gradientn(colors = c('darkorchid4', 'chocolate1')) +
  theme_void() +
  labs(fill = 'Energy Burden (% of Income)')
```
```{r}
#| fig-cap: "No data for counties in gray."

tmap_mode("view") 

tm_shape(county_sunroof_lead_sf) + 
  tm_polygons('energy_burden_percent_income', palette= c("darkorchid4", "chocolate1"), 
                           title='Energy Burden (% Income)',
                           border.col='grey27', alpha=.9) +
  tm_shape(county_sunroof_lead_sf) +
  tm_polygons('yearly_sunlight_kwh_median', palette= c("darkorchid4", "chocolate1"), 
                           title='Median Annual Sunlight (kWh)',
                           border.col='grey27', alpha=.9) +
  tm_shape(county_sunroof_lead_sf) +
  tm_polygons('household_income', palette= c("darkorchid4", "chocolate1"), 
                           title='Household Income ($)',
                           border.col='grey27', alpha=.9) +
  tm_shape(county_sunroof_lead_sf) +
  tm_polygons('percent_qualified', palette= c("darkorchid4", "chocolate1"), 
                           title='Percent of Solar-Qualified Households',
                           border.col='grey27', alpha=.9) +
  tmap_options(max.categories= 57) +
tm_view(view.legend.position = c("right", "top"))+
tm_layout(title= 'Solar Potential: Environmental Justice', 
            title.position = c('right', 'top'))
```












